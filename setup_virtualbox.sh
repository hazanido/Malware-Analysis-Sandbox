#!/bin/bash

echo "Downloading Ubuntu Server if not already present..."
ISO_URL="https://ubuntu.interhost.co.il/noble/ubuntu-24.04-live-server-amd64.iso"
ISO_FILENAME="ubuntu-24.04-live-server-amd64.iso"

if [ ! -f "$ISO_FILENAME" ]; then
    echo "ISO file not found. Downloading..."
    curl -O "$ISO_URL"
else
    echo "$ISO_FILENAME already exists."
fi

VM_NAME="MalwareAnalysis"

VBOXMANAGE=$(which VBoxManage)
if [ -z "$VBOXMANAGE" ]; then
    echo "VBoxManage command not found. Please ensure VirtualBox is installed and VBoxManage is in your PATH."
    exit 1
fi

echo "Checking if VM with the name '$VM_NAME' already exists..."
VM_EXISTS=$("$VBOXMANAGE" list vms | grep "\"$VM_NAME\"")

if [ "$VM_EXISTS" ]; then
    echo "VM '$VM_NAME' already exists. Deleting it..."
    "$VBOXMANAGE" unregistervm "$VM_NAME" --delete
    rm -rf ~/VirtualBoxVMs/"$VM_NAME"
    echo "VM '$VM_NAME' deleted."
else
    echo "No existing VM found with the name '$VM_NAME'."
fi

echo "Setting up VirtualBox VM..."
"$VBOXMANAGE" createvm --name "$VM_NAME" --ostype Ubuntu_64 --register
"$VBOXMANAGE" modifyvm "$VM_NAME" --memory 2048 --cpus 2 --nic1 nat
"$VBOXMANAGE" createhd --filename ~/VirtualBoxVMs/"$VM_NAME"/"$VM_NAME".vdi --size 20480 --format VDI
"$VBOXMANAGE" storagectl "$VM_NAME" --name "SATA Controller" --add sata --controller IntelAhci
"$VBOXMANAGE" storageattach "$VM_NAME" --storagectl "SATA Controller" --port 0 --device 0 --type hdd --medium ~/VirtualBoxVMs/"$VM_NAME"/"$VM_NAME".vdi

ISO_PATH="$PWD/$ISO_FILENAME"
"$VBOXMANAGE" storageattach "$VM_NAME" --storagectl "SATA Controller" --port 1 --device 0 --type dvddrive --medium "$ISO_PATH"

echo "VM Created successfully. Please start the VM and install Ubuntu Server."
